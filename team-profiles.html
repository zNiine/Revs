<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Profiles - Baseball Analytics</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #fff; font-family: Arial, sans-serif; }
    header, nav { padding: 1rem 2rem; border-bottom: 1px solid #ddd; }
    header { display: flex; justify-content: space-between; align-items: center; }
    #logo { font-size: 1.5rem; font-weight: bold; }
    main { padding: 2rem; }
    .filter-container { margin-bottom: 1rem; }
    .filter-container input { padding: 0.5rem; width: 200px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: center; }
    th { background: #f4f4f4; cursor: pointer; }
    th.sort-asc::after { content: ' ▲'; }
    th.sort-desc::after { content: ' ▼'; }
  </style>
</head>
<body>
  <header>
    <div id="logo">Team Profile</div>
  </header>
  <nav>
    <ul style="list-style:none; display:flex; gap:1rem; padding:1rem 2rem;">
      <li><a href="index.html">Home</a></li>
      <li><a href="leaderboards.html">Leaderboards</a></li>
      <li><a href="park-factors.html">Park Factors</a></li>
      <li><a href="#" class="active">Team Profiles</a></li>
    </ul>
  </nav>
  <main>
    <h2 id="team-name"></h2>
    <div class="filter-container">
      <label for="player-filter">Filter by player: </label>
      <input type="text" id="player-filter" placeholder="Enter player name" />
    </div>
    <div class="weights-legend" style="margin-bottom:1rem; font-size:0.9rem;">
      <strong>wOBA Weights:</strong> BB=0.69, HBP=0.72, 1B=0.88, 2B=1.24, 3B=1.56, HR=2.10, SF=0.73
    </div>
    <table id="profile-table">
      <thead>
        <tr>
          <th data-key="Player">Player</th>
          <th data-key="wOBA">wOBA</th>
          <th data-key="HardHitPct">HardHit%</th>
          <th data-key="AvgExitVel">Avg Exit Vel</th>
          <th data-key="AvgLaunchAng">Avg Launch Ang</th>
          <th data-key="PullPct">Pull%</th>
          <th data-key="StraightPct">Straight%</th>
          <th data-key="OppoPct">Oppo%</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // simple URL param helper
    function getParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }
    
    // hit classification
    const isHit = r => ['Single','Double','Triple','HomeRun'].includes(r.PlayResult);
    // spray angle buckets
    const pull = r => {
      const dir = parseFloat(r.Direction);
      return r.BatterSide==='R'? dir<=-8 : dir>=8;
    };
    const oppo = r => {
      const dir = parseFloat(r.Direction);
      return r.BatterSide==='R'? dir>=8 : dir<=-8;
    };
    const straight = r => {
      const dir = parseFloat(r.Direction);
      return dir>-8 && dir<8;
    };
    // wOBA weights
    const w = { BB:0.69, HBP:0.72, Single:0.88, Double:1.24, Triple:1.56, HomeRun:2.10, Sacrifice:0.73 };

    let sortKey='Player', sortAsc=true;
    let currentFilter='';

    function renderTable(profiles) {
      const tbody = document.querySelector('#profile-table tbody');
      tbody.innerHTML = '';
      let data = profiles;
      if (currentFilter) {
        data = data.filter(p => p.Player.toLowerCase().includes(currentFilter.toLowerCase()));
      }
      data.sort((a,b) => {
        const va=a[sortKey], vb=b[sortKey];
        if (typeof va==='string') return sortAsc? va.localeCompare(vb): vb.localeCompare(va);
        return sortAsc? va-vb: vb-va;
      });
      data.forEach(p => {
        const tr = document.createElement('tr');
        ['Player','wOBA','HardHitPct','AvgExitVel','AvgLaunchAng','PullPct','StraightPct','OppoPct']
          .forEach(key => {
            const td = document.createElement('td');
            td.textContent = typeof p[key]==='number'
              ? (key==='wOBA'? p[key].toFixed(3): p[key].toFixed(1))
              : p[key];
            tr.appendChild(td);
          });
        tbody.appendChild(tr);
      });
    }

    // main parsing & computation
    Papa.parse('./data.csv', {
      download:true, header:true, skipEmptyLines:true,
      complete: ({data}) => {
        const team = getParam('team');
        document.getElementById('team-name').textContent = team;
        // identify team abbreviation
        const row = data.find(r=>r.HomeNameFull===team) || data.find(r=>r.AwayNameFull===team);
        const abbr = row
          ? (row.HomeNameFull===team? row.HomeTeam: row.AwayTeam)
          : null;
        const teamRows = data.filter(r=>
          (r.HomeNameFull===team && r.BatterTeam===abbr) ||
          (r.AwayNameFull===team && r.BatterTeam===abbr)
        );
        
        // player buckets
        const players={}, pas={};
        teamRows.forEach(r=>{
          // accumulate PAs for wOBA
          const paKey = `${r.GameID}-${r.PAofInning}-${r.Inning}-${r['Top/Bottom']}`;
          pas[paKey] = pas[paKey]||[]; pas[paKey].push(r);
          // init player
          const b = r.Batter;
          if (!players[b]) players[b] = {
            pa:0, bb:0, hbp:0, sf:0,
            hr:0, triples:0, doubles:0, singles:0,
            exitSum:0, exitCount:0, hardHits:0,
            angleSum:0, angleCount:0,
            pullCount:0, straightCount:0, oppoCount:0,
            batted:0
          };
        });
        // compute wOBA
        Object.values(pas).forEach(pa=>{
          const last = pa.reduce((a,b)=> +a.PitchofPA>+b.PitchofPA? a:b);
          const p = players[last.Batter]; p.pa++;
          if (last.KorBB==='Walk') p.bb++;
          else if (last.PitchCall==='HitByPitch') p.hbp++;
          else if (last.PlayResult==='Sacrifice') p.sf++;
          else if (last.PlayResult==='HomeRun') { p.hr++; p.batted++; }
          else if (last.PlayResult==='Triple')  { p.triples++; p.batted++; }
          else if (last.PlayResult==='Double')  { p.doubles++; p.batted++; }
          else if (last.PlayResult==='Single')  { p.singles++; p.batted++; }
        });
        // per-pitch InPlay exit/angle
        teamRows.forEach(r=>{
          const p=players[r.Batter];
          if (r.PitchCall==='InPlay') {
            const velo = parseFloat(r.ExitSpeed);
            if (!isNaN(velo)) {
              p.exitSum += velo;
              p.exitCount++;
              if (velo >= 95) p.hardHits++;
            }
            const ang = parseFloat(r.Angle);
            if (!isNaN(ang)) {
              p.angleSum += ang;
              p.angleCount++;
            }
          }
          // spray on hits only
          if (['Single','Double','Triple','HomeRun'].includes(r.PlayResult)) {
            p.batted++;
            if (pull(r)) p.pullCount++;
            else if (straight(r)) p.straightCount++;
            else if (oppo(r)) p.oppoCount++;
          }
        });
        
        // assemble profiles
        const profiles = [];
        Object.entries(players).forEach(([name,p])=>{
          const woba = (w.BB*p.bb + w.HBP*p.hbp + w.Single*p.singles + w.Double*p.doubles + w.Triple*p.triples + w.HomeRun*p.hr + w.Sacrifice*p.sf) / p.pa;
          const sprDen = p.pullCount + p.straightCount + p.oppoCount;
          profiles.push({
            Player: name,
            wOBA: woba,
            HardHitPct: p.exitCount? p.hardHits/p.exitCount*100:0,
            AvgExitVel: p.exitCount? p.exitSum/p.exitCount:0,
            AvgLaunchAng: p.angleCount? p.angleSum/p.angleCount:0,
            PullPct: sprDen? p.pullCount/sprDen*100:0,
            StraightPct: sprDen? p.straightCount/sprDen*100:0,
            OppoPct: sprDen? p.oppoCount/sprDen*100:0
          });
        });
        
        // filter & sorting
        document.getElementById('player-filter').addEventListener('input', e=>{ currentFilter = e.target.value; renderTable(profiles); });
        document.querySelectorAll('#profile-table th').forEach(th=>th.addEventListener('click',()=>{
          const key = th.dataset.key;
          if (sortKey===key) sortAsc=!sortAsc;
          else { sortKey=key; sortAsc=true; }
          document.querySelectorAll('th').forEach(h=>h.classList.remove('sort-asc','sort-desc'));
          th.classList.add(sortAsc?'sort-asc':'sort-desc');
          renderTable(profiles);
        }));
        renderTable(profiles);
      }
    });
  </script>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBgBqrrRBB1vvAnQ9mNBt9Vq6p2NWeKYZw",
    authDomain: "revs-2c987.firebaseapp.com",
    projectId: "revs-2c987",
    storageBucket: "revs-2c987.firebasestorage.app",
    messagingSenderId: "181256684157",
    appId: "1:181256684157:web:a9e1c5dfd767658e2ba714",
    measurementId: "G-2050889X0C"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  firebase.initializeApp(firebaseConfig);

</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const auth = firebase.auth();

      // Redirect to login if not authenticated
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'login.html';
        } else {
        }
      });

      
    });
</script>
</body>
</html>
