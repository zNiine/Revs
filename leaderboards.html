
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboards – Baseball Analytics</title>

<style>

   .modalOverlay {
          display: none;
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.6);
          align-items: center;
          justify-content: center;
          z-index: 10000;
        }
        .modalOverlay.show { display: flex; }
        #modalContent {
          background: #fff;
          border-radius: 8px;
          width: 80vw;
          height: 80vh;
          position: relative;
          overflow: hidden;
          box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #modalClose {
          position: absolute; top: 8px; right: 12px;
          font-size: 1.5rem; cursor: pointer; z-index: 1;
        }
        #animFrame {
          width:100%; height:100%; border:none;
        }
    /* === RESET & BASE === */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
html {
  scroll-behavior: smooth;
}
body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background: #fff;
  font-family: Arial, sans-serif;
  line-height: 1.4;
}

/* === TOP BAR (NAV + SEARCH) === */
header.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 2rem;
  background: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  position: sticky;
  top: 0;
  z-index: 10;
}
header.top-bar nav#menu ul {
  list-style: none;
  display: flex;
  gap: 2rem;
}
header.top-bar nav#menu a {
  text-decoration: none;
  color: #333;
  font-weight: 500;
  padding: 0.5rem;
  border-radius: 4px;
  transition: background 0.2s;
}
header.top-bar nav#menu a:hover {
  background: #f0f0f0;
}
header.top-bar nav#menu a.active {
  color: #007bff;
  background: rgba(0,123,255,0.1);
}
header.top-bar .search-container {
  display: flex;
  gap: 0.5rem;
}
header.top-bar .search-container input {
  padding: 0.5rem 0.75rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  min-width: 200px;
  transition: border-color 0.2s;
}
header.top-bar .search-container input:focus {
  outline: none;
  border-color: #007bff;
}
header.top-bar .search-container button {
  padding: 0.5rem 0.75rem;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}
header.top-bar .search-container button:hover {
  background: #0056b3;
}

/* === SECONDARY NAV === */
nav#subMenu {
  background: #fafafa;
  border-bottom: 1px solid #ddd;
  padding: 0.5rem 2rem;
}
nav#subMenu ul {
  list-style: none;
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}
nav#subMenu a {
  text-decoration: none;
  color: #333;
}

/* === GLOBAL FILTERS === */
.global-filters {
  padding: 1rem 2rem;
  border-bottom: 1px solid #ddd;
}
.global-filters label {
  margin-right: 0.5rem;
  font-weight: 500;
}
.global-filters select {
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* === TWO-COLUMN LAYOUT === */
.layout {
  display: flex;
  flex: 1;
  gap: 1rem;
  padding: 2rem;
  overflow: hidden;
}
main#cards-container {
  flex: 3;
  overflow-y: auto;
  padding-right: 1rem;
}
aside#sidebar {
  flex: 1;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 1rem;
  overflow-y: auto;
  max-height: calc(100vh - 6rem);
}
aside#sidebar h3 {
  margin-bottom: 1rem;
  font-size: 1.1rem;
  border-bottom: 1px solid #ddd;
  padding-bottom: 0.5rem;
}
#table-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
#table-list li {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: 4px;
  transition: background 0.2s;
}
#table-list li:hover {
  background: #f9f9f9;
}
#table-list .drag-handle {
  cursor: grab;
  font-size: 1.2rem;
  color: #888;
}
#table-list input[type="checkbox"] {
  width: 1rem;
  height: 1rem;
}

/* === CARD STYLES === */
.card {
  width: 100%;
  margin-bottom: 1.5rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  background: #fff;
}
.card > summary {
  cursor: pointer;
  padding: 0.75rem 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card > summary:hover {
  background: #fafafa;
}
.card h2 {
  font-size: 1.1rem;
  margin: 0;
}

/* back‐to‐top button */
.back-to-top {
  font-size: 0.75rem;
  padding: 0.2rem 0.4rem;
  background: #eee;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
}
.back-to-top:hover {
  background: #ddd;
}

/* card‐internal filters */
.filters {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  padding: 0.5rem 1rem;
}
.filters input,
.filters select,
.filters label {
  padding: 0.4rem;
  border: 1px solid #ccc;
  border-radius: 3px;
}

/* === TABLE STYLES === */
.leaderboard {
  padding: 0 1rem 1rem;
}
.leaderboard table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.5rem;
  table-layout: auto;
}
.leaderboard th,
.leaderboard td {
  padding: 0.5rem;
  border: 1px solid #ccc;
  text-align: left;
}
.leaderboard tbody tr:nth-child(odd) {
  background: #f9f9f9;
}
.leaderboard thead th {
  position: sticky;
  top: 0;
  background: #eee;
  z-index: 1;
}

</style>>
</head>

<body>
  <header class="top-bar">
  <nav id="menu">
    <ul>
      <li><a href="index.html">Home</a></li>
                    <li><a href="schedule.html" >Standings</a></li>

                        <li><a href="games.html">Games</a></li>

      <li><a href="leaderboards.html" class="active">Leaderboards</a></li>
      <li><a href="park-factors.html">Park Factors</a></li>
      <li><a href="fielding.html">Fielding</a></li>
            <li><a href="stolen-bases.html" >Base Running</a></li>
            <li><a href="dong.html">Would it Dong?</a></li>

    </ul>
  </nav>

  <form id="search-form" class="search-container">
  <input
    type="text"
    id="search"
    placeholder="Search…"
    autocomplete="off"
    list="suggestions"  
  />
  <button type="submit" id="search-btn">Go</button>
  <datalist id="suggestions"></datalist>
</form>
</header>

  <nav id="subMenu">
    <ul>
      <li><a href="#hr-distance">Home Run Distance</a></li>
      <li><a href="#ev-speed">Exit Velocity</a></li>
      <li><a href="#chase-rate">Chase Rate</a></li>
      <li><a href="#release-speed">Release Speed</a></li>
      <li><a href="#catcher-stats">Catcher Stats</a></li>
      <li><a href="#avg-ev">Avg Exit Velocitry</a></li>
      <li><a href="#umpire-accuracy">Umpire Accuracy</a></li>
      <li><a href="#batter-run-exp">Batter Run Expectancy</a></li>
      <li><a href="#pitch-run-exp">Pitcher Run Expectancy</a></li>
      <li><a href="#spin-eff">Spin Effeciency</a></li>
      <li><a href="#pitcher-hh">Pitcher Hard Hit%</a></li>
      <li><a href="#batter-hh">Batter Hard Hit%</a></li>
      <li><a href="#barrel-pct">Barrel%</a></li>
      <li><a href="#sweetspot-pct">SweetSpot%</a></li>
      <li><a href="#avg-team-hr-dist">Avg Team HR Dist</a></li>

    </ul>
  </nav>

  <div class="global-filters">
    <label for="time-filter">Time Range:</label>
    <select id="time-filter">
      <option value="300">All Time</option>
      <option value="3">Yesterday</option>
      <option value="4">Last 3 Days</option>
      <option value="8">Last 7 Days</option>
      <option value="16">Last 15 Days</option>
      <option value="31">Last 30 Days</option>
    </select>
  </div>

  <div class="layout">
    <!-- LEFT: all cards -->
    <main id="cards-container">

      <!-- 1. Home Run Distance -->
      <details class="card" open>
        <summary>
          <h2>1. Home Run Distance</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="hr-distance">
          <div class="filters">
            <input type="text" id="hr-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="hr-player-filter" placeholder="Player" list="player-suggestions"/>
          </div>
          <table>
            <thead>
              <tr>
                <th>Team</th><th>Batter</th><th>Pitcher</th>
                <th>Exit Vel</th><th>Launch Ang</th><th>Distance</th>
                <th>PitchType</th><th>Date</th><th>Details</th><th>Watch</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 2. Exit Velocity -->
      <details class="card" open>
        <summary>
          <h2>2. Exit Velocity</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="ev-speed">
          <div class="filters">
            <input type="text" id="ev-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="ev-player-filter" placeholder="Player" list="player-suggestions"/>
            <select id="ev-playresult-filter"><option value="">All Results</option></select>
            <select id="ev-autotype-filter"><option value="">All Types</option></select>
          </div>
          <table>
            <thead>
              <tr>
                <th>Team</th><th>Batter</th><th>Pitcher</th>
                <th>Exit Vel</th><th>Launch Ang</th><th>Distance</th><th>Result</th>
                <th>PitchType</th><th>Date</th><th>Details</th><th>Watch</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 3. Chase Rate -->
      <details class="card" open>
        <summary>
          <h2>3. Chase Rate</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="chase-rate">
          <div class="filters">
            <input type="text" id="chase-team-filter" placeholder="Team" list="team-suggestions"/>
            <label for="chase-min-filter">Min Outside:</label>
            <input type="number" id="chase-min-filter" value="20" min="1"/>
          </div>
          <table>
            <thead><tr><th>Player</th><th>Chase Rate</th><th>Total Outside</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 4. Release Speed -->
      <details class="card" open>
        <summary>
          <h2>4. Release Speed</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="release-speed">
          <div class="filters">
            <input type="text" id="rel-team-filter" placeholder="Team" list="team-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Pitcher</th><th>Release Speed</th><th>Call</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 5. Catcher Stats -->
      <details class="card" open>
        <summary>
          <h2>5. Catcher Stats</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="catcher-stats">
          <div class="filters">
            <input type="text" id="catcher-player-filter" placeholder="Catcher" list="player-suggestions"/>
            <input type="text" id="catcher-team-filter" placeholder="Team" list="team-suggestions"/>
          </div>
          <table>
            <thead>
              <tr>
                <th>Catcher</th><th>Team</th><th>Avg PopTime</th>
                <th>Avg Exchange</th><th>Avg Throw</th><th>Attempts</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 6. Avg Exit Vel by Batter -->
      <details class="card" open>
        <summary>
          <h2>6. Avg Exit Velocity</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="avg-ev">
          <div class="filters">
            <input type="text" id="avg-ev-team-filter" placeholder="Team" list="team-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Batter</th><th>Team</th><th>Avg Exit Vel</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 7. Umpire Accuracy -->
      <details class="card" open>
        <summary>
          <h2>7. Umpire Accuracy</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="umpire-accuracy">
          <table>
            <thead><tr><th>Umpire</th><th>Accuracy</th><th>Total Calls</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 8. Batter Run Expectancy -->
      <details class="card" open>
        <summary>
          <h2>8. Batter Run Expectancy</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="batter-run-exp">
          <div class="filters">
            <input type="text" id="bre-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="bre-batter-filter" placeholder="Batter" list="player-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Batter</th><th>Pitch Type</th><th>Avg RV</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 9. Pitcher Run Expectancy -->
      <details class="card" open>
        <summary>
          <h2>9. Pitcher Run Expectancy</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="pitch-run-exp">
          <div class="filters">
            <input type="text" id="pre-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="pre-pitcher-filter" placeholder="Pitcher" list="player-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Pitcher</th><th>Pitch Type</th><th>Avg RV</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 10. Spin Efficiency -->
      <details class="card" open>
        <summary>
          <h2>10. Spin Effeciency</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="spin-eff">
          <div class="filters">
            <input type="text" id="seam-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="seam-pitcher-filter" placeholder="Pitcher" list="player-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Pitcher</th><th>Type</th><th>SpinEff</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 11. Pitcher HardHit % -->
      <details class="card" open>
        <summary>
          <h2>11. Pitcher Hard Hit %</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="pitcher-hh">
          <div class="filters">
            <input type="text" id="hh-p-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="hh-p-pitcher-filter" placeholder="Pitcher" list="player-suggestions"/>
            <label for="hh-threshold">Threshold</label>
            <input type="number" id="hh-threshold" value="95" min="0" style="width:4rem"/> mph
          </div>
          <table>
            <thead><tr><th>Pitcher</th><th>HH%</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 12. Batter HardHit % -->
      <details class="card" open>
        <summary>
          <h2>12. Batter Hard Hit %</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="batter-hh">
          <div class="filters">
            <input type="text" id="hh-b-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="hh-b-batter-filter" placeholder="Batter" list="player-suggestions"/>
            <label for="hh-b-threshold">Threshold</label>
            <input type="number" id="hh-b-threshold" value="95" min="0" style="width:4rem"/> mph
          </div>
          <table>
            <thead><tr><th>Batter</th><th>Team</th><th>HH%</th><th>Count</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 13. Barrel % -->
      <details class="card" open>
        <summary>
          <h2>13. Barrel%</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="barrel-pct">
          <div class="filters">
            <input type="text" id="barrel-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="barrel-player-filter" placeholder="Player" list="player-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Player</th><th>Barrel%</th><th>PA</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <!-- 14. SweetSpot % -->
      <details class="card" open>
        <summary>
          <h2>14. SweetSpot%</h2>
          <button class="back-to-top" onclick="location.hash='top'">↑</button>
        </summary>
        <div class="leaderboard" id="sweetspot-pct">
          <div class="filters">
            <input type="text" id="ss-team-filter" placeholder="Team" list="team-suggestions"/>
            <input type="text" id="ss-player-filter" placeholder="Player" list="player-suggestions"/>
          </div>
          <table>
            <thead><tr><th>Player</th><th>Sweet%</th><th>PA</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <details class="card" open>
  <summary>
    <h2>15. Average Team Home-Run Distance</h2>
    <button class="back-to-top" onclick="location.hash='top'">↑</button>
  </summary>
  <div class="leaderboard" id="avg-team-hr-dist">
    <!-- no extra filters for now -->
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Avg HR Distance (ft)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

    </main>

    <!-- RIGHT: sidebar -->
    <aside id="sidebar">
      <h3>Show / Hide & Order</h3>
      <ul id="table-list"></ul>
    </aside>
  </div>


     <div id="modalOverlay" class="modalOverlay">
      <div id="modalContent">
        <span id="modalClose">&times;</span>
        <iframe id="animFrame" src="" allowfullscreen></iframe>
      </div>
    </div>
  <datalist id="team-suggestions"></datalist>
  <datalist id="player-suggestions"></datalist>
 <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('cards-container');
    const list      = document.getElementById('table-list');

    // 1) Build list items with a data-target pointing at each card’s ID
    container.querySelectorAll('.card').forEach(card => {
      // give each <details> a unique ID if it doesn't have one:
      if (!card.id) card.id = 'card-' + Math.random().toString(36).slice(2);

      const title = card.querySelector('summary h2').textContent.trim();
      const li    = document.createElement('li');
      li.dataset.target = card.id;

      // checkbox to show/hide
      const cb = document.createElement('input');
      cb.type    = 'checkbox';
      cb.checked = true;
      cb.addEventListener('change', () => {
        card.style.display = cb.checked ? '' : 'none';
      });

      // drag handle
      const handle = document.createElement('span');
      handle.textContent = '☰';
      handle.style.cursor = 'grab';
      handle.classList.add('drag-handle');

      const label = document.createElement('span');
      label.textContent = ' ' + title;

      li.append(cb, handle, label);
      list.append(li);
    });

    // 2) Initialize Sortable on the sidebar list
    new Sortable(list, {
      handle: '.drag-handle',
      animation: 150,
      onEnd: () => {
        // read the new order of li’s
        Array.from(list.children).forEach(li => {
          const card = document.getElementById(li.dataset.target);
          if (card) container.appendChild(card);
        });
      }
    });
  });
</script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    
    const columns = {
      player: 'Batter',
      playerTeam: 'BatterTeam',
      pitcher: 'Pitcher',
      pitcherTeam: 'PitcherTeam',
      playResult: 'PlayResult',
      distance: 'Distance',
      exitSpeed: 'ExitSpeed',
      relSpeed: 'RelSpeed',
      angle: 'Angle',
      ump: 'Umpire',
      autoType: 'AutoPitchType',
      plateHeight: 'PlateLocHeight',
      plateSide: 'PlateLocSide',
      pitchCall: 'PitchCall',
      homeAbbr: 'HomeTeam',
      awayAbbr: 'AwayTeam',
      homeFull: 'HomeNameFull',
      awayFull: 'AwayNameFull',
      date: 'Date'
    };
let fullUmpireRows = [];

    let data = [];
    const teams = new Set(), playersSet = new Set();

    function getFullTeamName(abbr, row) {
      if (abbr === row[columns.homeAbbr]) return row[columns.homeFull];
      if (abbr === row[columns.awayAbbr]) return row[columns.awayFull];
      return abbr;
    }

    function initFilters() {
      teams.forEach(t => document.getElementById('team-suggestions').append(new Option(t)));
      playersSet.forEach(p => document.getElementById('player-suggestions').append(new Option(p)));
    }

    function renderLeaderboard(id, rows, cols) {
  const tbody = document.querySelector(`#${id} tbody`);
  tbody.innerHTML = '';

  rows.forEach(r => {
    const tr = document.createElement('tr');

    cols.forEach(c => {
      const td = document.createElement('td');
      const val = r[c];

      // build profile links for known columns
      let url = null;
      if (c === 'Batter') {
        url = `batter-profiles.html?player=${encodeURIComponent(val)}`;
      } else if (c === 'Pitcher') {
        url = `pitcher-profiles.html?player=${encodeURIComponent(val)}`;
      } else if (c === 'Umpire') {
        url = `ump-profiles.html?player=${encodeURIComponent(val)}`;
      } else if (c === 'Team') {
        url = `team-profiles.html?team=${encodeURIComponent(val)}`;
      }

      if (url) {
        const a = document.createElement('a');
        a.href = url;
        a.textContent = val;
        td.appendChild(a);

      } else if (c === 'Details') {
        // render the HTML you prepared in r.Details
        td.innerHTML = r.Details;

      } else if (c === 'Details' || c === 'Watch' || c === 'Animate') {
    // render HTML for both Details and Watch
    td.innerHTML = val;

  } else {
        td.textContent = val;
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}


const RV = {
  StrikeCalled:  0.1,
  BallCalled:   -0.1,
  StrikeSwinging: 0.3
  // HomeRuns are handled separately as -0.5 in your code
};

// MLB run expectancy by Ball-Strike count (runs to come)
// Source: aggregate across seasons (0-0 through 3-2)
const RE_COUNT = {
  '0-0': 0.496, '0-1': 0.383, '0-2': 0.254,
  '1-0': 0.621, '1-1': 0.508, '1-2': 0.379,
  '2-0': 0.703, '2-1': 0.590, '2-2': 0.455,
  '3-0': 0.855, '3-1': 0.736, '3-2': 0.602
};

// League‐average RE after a hit/out ends the PA
const RE_AFTER_HIT = {
  Single: 0.757,   // avg RE with runner on 1st, 0 outs
  Double: 1.053,   // runner on 2nd, 0 outs
  Triple: 1.560,   // runner on 3rd, 0 outs
  // for any generic out we'll approximate a single‐out transition
  Out:    0.250    // avg RE after a typical out
};


// 10) Spin Efficiency
function drawSpinEfficiency(rows) {
  const map = {};
  rows.forEach(r => {
    const pit = r[columns.pitcher],
          pt  = r[columns.autoType];
    const sv = parseFloat(r.SpinRate),
          vb = parseFloat(r.InducedVertBreak);
    if (!pit || !pt || isNaN(sv) || isNaN(vb)) return;
    const eff = vb/sv*1000;
    map[pit] = map[pit] || {};
    map[pit][pt] = map[pit][pt] || { sum:0, c:0, team: getFullTeamName(r[columns.pitcherTeam],r) };
    map[pit][pt].sum += eff;
    map[pit][pt].c   += 1;
  });
  let out = [];
  Object.entries(map).forEach(([pit, pts]) => {
    Object.entries(pts).forEach(([pt, v]) => {
      if (v.c < 15) return;
      out.push({
        Pitcher: pit,
        PitchType: pt,
        SpinEff:   (v.sum/v.c).toFixed(1),
        Count:     v.c,
        Team:      v.team
      });
    });
  });
  // filters
  const teamF = document.getElementById('seam-team-filter').value;
  const pitF  = document.getElementById('seam-pitcher-filter').value;
  if (teamF) out = out.filter(r=>r.Team===teamF);
  if (pitF)  out = out.filter(r=>r.Pitcher===pitF);
  // sort descending
  out.sort((a,b)=>b.SpinEff - a.SpinEff);
renderLeaderboard('spin-eff',
  out.slice(0,10),
  ['Pitcher','PitchType','SpinEff','Count']
);  // sortable
  const tbl = document.getElementById('spin-eff');
  tbl.querySelectorAll('th[data-key]').forEach(th=>{
    th.style.cursor = 'pointer';
    th.onclick = ()=>{
      const key = th.dataset.key;
      const asc = !th.classList.contains('asc');
      out.sort((a,b)=>
        asc ? (a[key]>b[key]?1:-1) : (a[key]<b[key]?1:-1)
      );
renderLeaderboard('spin-eff',
  out.slice(0,10),
  ['Pitcher','PitchType','SpinEff','Count']
);      tbl.querySelectorAll('th').forEach(h=>h.classList.remove('asc','desc'));
      th.classList.add(asc?'asc':'desc');
    };
  });
}

// 11) Pitcher HardHit%
function drawPitcherHardHit(rows) {
  const threshold = +document.getElementById('hh-threshold').value;
  const map = {};
  rows.forEach(r => {
    const pit = r[columns.pitcher];
    const ev  = parseFloat(r[columns.exitSpeed]);
    if (!pit || isNaN(ev)) return;
    map[pit] = map[pit] || { hh:0, tot:0, team: getFullTeamName(r[columns.pitcherTeam],r) };
    map[pit].tot++;
    if (ev >= threshold) map[pit].hh++;
  });
  let out = Object.entries(map).map(([pit, v])=>({
    Pitcher: pit,
    HHPct:   ((v.hh/v.tot)*100).toFixed(1),
    Count:   v.tot,
    Team:    v.team
  })).filter(r=>r.Count>=15);
  // filters
  const teamF = document.getElementById('hh-p-team-filter').value;
  const pitF  = document.getElementById('hh-p-pitcher-filter').value;
  if (teamF) out = out.filter(r=>r.Team===teamF);
  if (pitF)  out = out.filter(r=>r.Pitcher===pitF);
  // sort descending
  out.sort((a,b)=>a.HHPct - b.HHPct);
renderLeaderboard('pitcher-hh',
  out.slice(0,10),
  ['Pitcher','HHPct','Count']
);}

// 12) Batter HardHit%
function drawBatterHardHit(rows) {
  const threshold = +document.getElementById('hh-b-threshold').value;
  const teamF     = document.getElementById('hh-b-team-filter').value;
  const batF      = document.getElementById('hh-b-batter-filter').value;

  // build per-batter counts and team
  const map = {};
  rows.forEach(r => {
    if (r.PitchCall !== 'InPlay') return;
    const ev = parseFloat(r.ExitSpeed);
    if (isNaN(ev)) return;
    const bat  = r[columns.player];
    const team = getFullTeamName(r[columns.playerTeam], r);
    if (!map[bat]) map[bat] = { hh:0, tot:0, team };
    map[bat].tot++;
    if (ev >= threshold) map[bat].hh++;
  });

  // flatten into array
  let out = Object.entries(map).map(([bat, v]) => ({
    Batter:    bat,
    Team:       v.team,
    HHPct:     ((v.hh/v.tot)*100).toFixed(1),
    Count:     v.tot
  }));

  // apply filters
  if (teamF) out = out.filter(r => r.Team === teamF);
  if (batF)  out = out.filter(r => r.Batter === batF);

  // only show those with enough PAs, sort and slice
  out = out.filter(r => r.Count >= 15)
           .sort((a,b)=>b.HHPct - a.HHPct)
           .slice(0,10);

  renderLeaderboard('batter-hh', out, ['Batter','Team','HHPct','Count']);
}


function bindWatchButtons() {
  document.querySelectorAll('.watch-btn').forEach(btn => {
    btn.removeEventListener('click', btn._watchHandler);
    const handler = () => {
      const gameUID  = btn.dataset.game;
      const pitchUID = btn.dataset.pitch;
      watchVideo(gameUID, pitchUID);
    };
    btn.addEventListener('click', handler);
    // keep a reference so we can remove() before re-binding if you re-render
    btn._watchHandler = handler;
  });
}

// inside computeAndRender(), at the very end:
bindWatchButtons();


    function computeAndRender() {
      // time filter
      // pick up how many days the user wants (1 = yesterday-today)
// and compute a cutoff that is midnight-of-(days-1) days ago
const days = +document.getElementById('time-filter').value;
let cutoff = 0;
if (days > 0) {
  // start with today at local midnight:
  const d0 = new Date();
  d0.setHours(0,0,0,0);
  // back up (days - 1) full days
  cutoff = d0.getTime() - (days - 1) * 24 * 3600 * 1000;
}
// now filter
const filtered = data.filter(r =>
  !cutoff || new Date(r[columns.date]).getTime() >= cutoff
);


  // 1) Filter to HomeRuns
let hrRows = filtered.filter(r => r[columns.playResult] === 'HomeRun');
const hrTeam   = document.getElementById('hr-team-filter').value;
const hrPlayer = document.getElementById('hr-player-filter').value;
if (hrTeam)   hrRows = hrRows.filter(r => getFullTeamName(r[columns.playerTeam], r) === hrTeam);
if (hrPlayer) hrRows = hrRows.filter(r => r[columns.player] === hrPlayer);
hrRows.sort((a,b) => parseFloat(b[columns.distance]) - parseFloat(a[columns.distance]));

// 2) Map into display objects (including Details + Watch)
const hrDisplay = hrRows.slice(0,10).map(r => ({
  Team:          getFullTeamName(r[columns.playerTeam], r),
  Batter:        r[columns.player],
  Pitcher:       r[columns.pitcher],
  'Exit Vel':    r[columns.exitSpeed],
  'Launch Ang':  r[columns.angle],
  Distance:      r[columns.distance],
  AutoPitchType: r[columns.autoType],
  Date:          r[columns.date],
  Details:       `<a href="Game-view.html?pitchUID=${r.PitchUID}">View</a>`,
  Watch:         `<button
          style="padding:.2rem .5rem;cursor:pointer;"
          onclick="watchVideo('${r.GameUID}', '${r.PlayID}')">
          ▶️ Watch
        </button>
        
         <button class="details-button"
          onclick="watchImage('${r.GameUID}', '${r.PlayID}')">
    Composite
  </button>`
}));

// 3) Render with a dedicated Watch column
renderLeaderboard(
  'hr-distance',
  hrDisplay,
  [
    'Team',
    'Batter',
    'Pitcher',
    'Exit Vel',
    'Launch Ang',
    'Distance',
    'AutoPitchType',
    'Date',
    'Details',
    'Watch'            // <-- New column here
  ]
);


      // 2. Fastest Exit Velocity
      let evRows = filtered.filter(r =>
        r[columns.exitSpeed] && r[columns.playResult] !== 'Undefined'
      );
      const evTeam = document.getElementById('ev-team-filter').value;
      const evPlayer = document.getElementById('ev-player-filter').value;
      if (evTeam)   evRows = evRows.filter(r => getFullTeamName(r[columns.playerTeam],r) === evTeam);
      if (evPlayer) evRows = evRows.filter(r => r[columns.player] === evPlayer);
      const evResult = document.getElementById('ev-playresult-filter').value;
if (evResult) evRows = evRows.filter(r => r.PlayResult === evResult);

const evType = document.getElementById('ev-autotype-filter').value;
if (evType) evRows = evRows.filter(r => r.AutoPitchType === evType);

      evRows.sort((a,b) => parseFloat(b[columns.exitSpeed]) - parseFloat(a[columns.exitSpeed]));
const evDisplay = evRows.slice(0,10).map(r => ({
  Team:       getFullTeamName(r[columns.playerTeam],r),
  Batter:     r[columns.player],
  Pitcher:    r[columns.pitcher],
  'Exit Vel': r[columns.exitSpeed],
  'Launch Ang': r[columns.angle],
  Distance:   r[columns.distance],
  PlayResult: r[columns.playResult],
  AutoPitchType: r[columns.autoType],
  Date:       r[columns.date],
  Details:    `<a href="Game-view.html?pitchUID=${r.PitchUID}">View</a>`,
  Watch:      `<button
          style="padding:.2rem .5rem;cursor:pointer;"
          onclick="watchVideo('${r.GameUID}', '${r.PlayID}')">
          ▶️ Watch
        </button>
        
         <button class="details-button"
          onclick="watchImage('${r.GameUID}', '${r.PlayID}')">
    Composite
  </button>`

        
}));

renderLeaderboard(
  'ev-speed',
  evDisplay,
  ['Team','Batter','Pitcher','Exit Vel','Launch Ang','Distance','PlayResult','AutoPitchType','Date','Details','Watch']
);


      [
  'ev-team-filter',
  'ev-player-filter',
  'ev-playresult-filter',   // ← new
  'ev-autotype-filter',     // ← new
  /* …the rest of your filter‐IDs… */
].forEach(id =>
  document.getElementById(id).addEventListener('input', computeAndRender)
);
      // 3. Chase Rate
      const chaseMap = {};
      filtered.forEach(r => {
        const h = parseFloat(r[columns.plateHeight]), s = parseFloat(r[columns.plateSide]);
        const outZone = (h < 1.5 || h > 3.5 || s < -0.83 || s > 0.83);
        if (!outZone) return;
        const batter = r[columns.player];
        if (!chaseMap[batter]) chaseMap[batter] = { outside:0, chase:0, team: getFullTeamName(r[columns.playerTeam],r) };
        chaseMap[batter].outside++;
        const call = r[columns.pitchCall];
        if (call !== 'StrikeCalled' && call !== 'BallCalled') chaseMap[batter].chase++;
      });
      let chaseRows = Object.entries(chaseMap).map(([player,stats])=>({
        Player: player,
        ChaseRate: stats.outside ? (stats.chase/stats.outside).toFixed(2) : '0.00',
        TotalOutside: stats.outside,
        Team: stats.team
      }));
      const chaseTeam = document.getElementById('chase-team-filter').value;
      const minOut = +document.getElementById('chase-min-filter').value;
      if (chaseTeam) chaseRows = chaseRows.filter(r => r.Team === chaseTeam);
      chaseRows = chaseRows.filter(r => r.TotalOutside >= minOut);
      chaseRows.sort((a,b) => parseFloat(a.ChaseRate) - parseFloat(b.ChaseRate));
      renderLeaderboard('chase-rate', chaseRows.slice(0,10), ['Player','ChaseRate','TotalOutside']);
// 4. Fastest Release Speed
let relRows = filtered.slice();

// team filter
const relTeam = document.getElementById('rel-team-filter').value;
if (relTeam) {
  relRows = relRows.filter(r =>
    getFullTeamName(r[columns.pitcherTeam], r) === relTeam
  );
}

// only keep rows where RelSpeed parses to a number
relRows = relRows.filter(r => {
  const v = parseFloat(r[columns.relSpeed]);
  return !isNaN(v);
});

// now sort descending
relRows.sort((a,b) =>
  parseFloat(b[columns.relSpeed]) - parseFloat(a[columns.relSpeed])
);

// map out the top 10
const relDisplay = relRows.slice(0,10).map(r => ({
  Pitcher:       r[columns.pitcher],
  'Release Speed': r[columns.relSpeed],
  PitchCall:     r[columns.pitchCall]
}));

renderLeaderboard('release-speed',
  relDisplay,
  ['Pitcher','Release Speed','PitchCall']
);
      
// 7. Catcher Stats
const catcherMap = {};
filtered.forEach(r => {
  // identify the catcher
  const c = r[columns.catcher] || r.Catcher || r.CatcherId;
  if (!c) return;

  // initialize if needed
  if (!catcherMap[c]) {
    const teamName = r[columns.catcherTeam] || r.CatcherTeam || '';
    catcherMap[c] = {
      popSum: 0, popCount: 0,
      exchSum: 0, exchCount: 0,
      throwSum: 0, throwCount: 0,
      team: getFullTeamName(teamName, r)
    };
  }
  const stats = catcherMap[c];

  // Pop Time
  const pop = parseFloat(r[columns.popTime] || r.PopTime || '');
  if (!isNaN(pop) && pop > 0) {
    stats.popSum += pop;
    stats.popCount++;
  }

  // Exchange Time
  const ex = parseFloat(r[columns.exchangeTime] || r.ExchangeTime || '');
  if (!isNaN(ex) && ex > 0) {
    stats.exchSum += ex;
    stats.exchCount++;
  }

  // Throw Speed
  const th = parseFloat(r[columns.throwSpeed] || r.ThrowSpeed || '');
  if (!isNaN(th) && th > 0) {
    stats.throwSum += th;
    stats.throwCount++;
  }
});

let catcherRows = Object.entries(catcherMap).map(([name, s]) => ({
  Catcher:      name,
  Team:         s.team,
  PopTime:      s.popCount   ? (s.popSum   / s.popCount).toFixed(2) : '',
  ExchangeTime: s.exchCount  ? (s.exchSum  / s.exchCount).toFixed(2) : '',
  ThrowSpeed:   s.throwCount ? (s.throwSum / s.throwCount).toFixed(2) : '',
  Attempts:     s.popCount
}));

// apply filters
const cpf = document.getElementById('catcher-player-filter').value;
if (cpf) catcherRows = catcherRows.filter(r => r.Catcher === cpf);
const ctf = document.getElementById('catcher-team-filter').value;
if (ctf) catcherRows = catcherRows.filter(r => catcherMap[r.Catcher].team === ctf);

// league average row
const total = catcherRows.reduce((acc, r) => {
  acc.popSum  += parseFloat(r.PopTime)      || 0;
  acc.exchSum += parseFloat(r.ExchangeTime) || 0;
  acc.throwSum+= parseFloat(r.ThrowSpeed)   || 0;
  acc.count  ++;
  acc.attempts+= r.Attempts;
  return acc;
}, { popSum:0, exchSum:0, throwSum:0, count:0, attempts:0 });

if (total.count > 0) {
  
}

// sort so league average goes last, then by PopTime asc
catcherRows.sort((a, b) =>
  (parseFloat(a.PopTime) || 0) - (parseFloat(b.PopTime) || 0)
);
// render
renderLeaderboard('catcher-stats', catcherRows.slice(0,10), [
  'Catcher','Team','PopTime','ExchangeTime','ThrowSpeed','Attempts'
]);

// make headers sortable
document.querySelectorAll('#catcher-stats th[data-key]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    const tbody = document.querySelector('#catcher-stats tbody');
    const rows  = Array.from(tbody.rows);
    const asc   = !th.classList.contains('asc');

    rows.sort((a,b) => {
      const headers = ['Catcher','Team','PopTime','ExchangeTime','ThrowSpeed','Attempts'];
      const idx = headers.indexOf(key);
      let va = key==='Catcher' || key==='Team'
               ? a.cells[idx].innerText
               : parseFloat(a.cells[idx].innerText);
      let vb = key==='Catcher' || key==='Team'
               ? b.cells[idx].innerText
               : parseFloat(b.cells[idx].innerText);
      if (key==='Catcher' || key==='Team') {
        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
      }
      return asc ? va - vb : vb - va;
    });

    tbody.innerHTML = '';
    rows.forEach(r => tbody.appendChild(r));

    document.querySelectorAll('#catcher-stats th').forEach(h => h.classList.remove('asc','desc'));
    th.classList.add(asc ? 'asc' : 'desc');
  });
});


 const teamMap = {};
  filtered.forEach(r => {
    if (r.PlayResult !== 'HomeRun') return;
    const dist = parseFloat(r.Distance);
    if (isNaN(dist)) return;

    // determine which full team name hit the HR
    const teamFull = (r.BatterTeam === r.HomeTeam)
      ? r.HomeNameFull
      : r.AwayNameFull;

    if (!teamMap[teamFull]) teamMap[teamFull] = { totalDist: 0, count: 0 };
    teamMap[teamFull].totalDist += dist;
    teamMap[teamFull].count++;
  });

  const avgTeamRows = Object.entries(teamMap)
    .map(([team, stats]) => ({
      Team: team,
      AvgDistance: (stats.totalDist / stats.count).toFixed(1)  // one decimal
    }))
    .sort((a, b) => b.AvgDistance - a.AvgDistance);

  renderLeaderboard(
    'avg-team-hr-dist',
    avgTeamRows,
    ['Team','AvgDistance']
  );

      // 5. Umpire Accuracy
      const umpMap = {};
filtered.forEach(r => {
  const call = r[columns.pitchCall];
  if (call !== 'StrikeCalled' && call !== 'BallCalled') return;
  const u = r[columns.ump];
  if (!umpMap[u]) umpMap[u] = { total:0, correct:0 };
  umpMap[u].total++;
  const h = parseFloat(r[columns.plateHeight]), s = parseFloat(r[columns.plateSide]);
  const inZone = h>=1.5 && h<=3.5 && s>=-0.83 && s<=0.83;
  if ((inZone && call==='StrikeCalled') || (!inZone && call==='BallCalled')) {
    umpMap[u].correct++;
  }
});

// build full array
fullUmpireRows = Object.entries(umpMap).map(([u,stats]) => ({
  Umpire: u,
  Accuracy: stats.total ? +(stats.correct/stats.total).toFixed(2) : 0,
  TotalCalls: stats.total
}));

// initial sort descending
fullUmpireRows.sort((a,b) => b.Accuracy - a.Accuracy);

// render the top 10
renderLeaderboard(
  'umpire-accuracy',
  fullUmpireRows.slice(0,100),
  ['Umpire','Accuracy','TotalCalls']
);
// right after computeAndRender, wire up the sorter:
const thAcc = document.querySelector('#umpire-accuracy th[data-key="Accuracy"]');
if (thAcc) {
  thAcc.style.cursor = 'pointer';
  thAcc.onclick = () => {
    // toggle ascending / descending
    const asc = !thAcc.classList.contains('asc');
    fullUmpireRows.sort((a, b) => asc ? a.Accuracy - b.Accuracy : b.Accuracy - a.Accuracy);
    // re-render top 10
    renderLeaderboard(
      'umpire-accuracy',
      fullUmpireRows.slice(0,10),
      ['Umpire','Accuracy','TotalCalls']
    );
    // update arrow classes
    document.querySelectorAll('#umpire-accuracy th').forEach(h=>h.classList.remove('asc','desc'));
    thAcc.classList.add(asc ? 'asc' : 'desc');
  };
}

      // 6. Average Exit Velocity by Batter
      const avgMap = {};
      filtered
        .filter(r => r[columns.pitchCall] === 'InPlay' && !isNaN(parseFloat(r[columns.exitSpeed])))
        .forEach(r => {
          const bat = r[columns.player];
          const tm  = getFullTeamName(r[columns.playerTeam],r);
          if (!avgMap[bat]) avgMap[bat] = { sum:0, count:0, team: tm };
          avgMap[bat].sum   += parseFloat(r[columns.exitSpeed]);
          avgMap[bat].count += 1;
        });
        let minCount = 10
      let avgRows = Object.entries(avgMap)
  .filter(([b, st]) => st.count >= minCount)
  .map(([b, st]) => ({
    Batter: b,
    Team:   st.team,
    AvgExitVelocity: (st.sum / st.count).toFixed(2),
  }));

// then your existing team-filter + sort + render
const avgTeam = document.getElementById('avg-ev-team-filter').value;
if (avgTeam) {
  avgRows = avgRows.filter(r => r.Team === avgTeam);
}

avgRows.sort((a,b) =>
  parseFloat(b.AvgExitVelocity) - parseFloat(a.AvgExitVelocity)
);

renderLeaderboard(
  'avg-ev',
  avgRows.slice(0,10),
  ['Batter','Team','AvgExitVelocity']
);




      drawBatterRunExp(filtered);
      ['bre-team-filter','bre-batter-filter'].forEach(id => {
  document.getElementById(id).addEventListener('input', computeAndRender);
});
drawTruePitchRunExp(filtered);
['pre-team-filter','pre-pitcher-filter'].forEach(id => {
  document.getElementById(id).addEventListener('input', computeAndRender);
});

// 10) Spin Efficiency
drawSpinEfficiency(filtered);

// 11) Pitcher HardHit%
drawPitcherHardHit(filtered);

// 12) Batter HardHit%
['hh-b-team-filter','hh-b-batter-filter','hh-b-threshold']
  .forEach(id =>
    document.getElementById(id)
      .addEventListener('input', computeAndRender)
  );

  drawBatterHardHit(filtered)

drawBarrelPct(filtered);
  drawSweetSpotPct(filtered);
['barrel-team-filter','barrel-player-filter','ss-team-filter','ss-player-filter']
  .forEach(id => document.getElementById(id)
    .addEventListener('input', computeAndRender));

    }

    function drawBarrelPct(rows) {
  const teamF = document.getElementById('barrel-team-filter').value;
  const playerF = document.getElementById('barrel-player-filter').value;

  // build raw counts
  const map = {};
  rows.forEach(r => {
    if (r.PitchCall!=='InPlay') return;
    const ev = parseFloat(r.ExitSpeed), la = parseFloat(r.Angle);
    if (isNaN(ev)||isNaN(la)) return;
    const team = getFullTeamName(r[columns.playerTeam], r);
    const bat = r[columns.player];
    map[bat] = map[bat] || { barrel:0, pa:0, team };
    map[bat].pa++;
    if (ev>=98 && la>=26 && la<=32) map[bat].barrel++;
  });

  // flatten & filter
  let rowsOut = Object.entries(map).map(([bat,s])=>({
    Player: bat,
    'Barrel %': +(s.barrel/s.pa*100).toFixed(1),
    'Plate Apps': s.pa,
    Team: s.team
  }));
  if (teamF) rowsOut = rowsOut.filter(r=>r.Team===teamF);
  if (playerF) rowsOut = rowsOut.filter(r=>r.Player===playerF);
  rowsOut = rowsOut.filter(r=>r['Plate Apps']>=10)
                   .sort((a,b)=>b['Barrel %']-a['Barrel %'])
                   .slice(0,10);

  renderLeaderboard('barrel-pct', rowsOut, ['Player','Barrel %','Plate Apps']);
}


function watchVideo(gameUID, pitchUID) {
  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position: 'fixed', top:0, left:0, right:0, bottom:0,
    background: 'rgba(0,0,0,0.8)', display:'flex',
    alignItems:'center', justifyContent:'center', zIndex:10000
  });
  const video = document.createElement('video');
  video.controls = true;
  video.autoplay = true;
  Object.assign(video.style, {
    maxWidth:'90%', maxHeight:'90%', background:'#000'
  });
  video.src = `https://helloworld.idkconflict1.workers.dev/stream_video`
    + `?session_id=${encodeURIComponent(gameUID)}`
    + `&track_id=${encodeURIComponent(pitchUID)}`;
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '✕';
  Object.assign(closeBtn.style, {
    position:'absolute', top:'10px', right:'10px',
    fontSize:'1.5rem', background:'transparent',
    border:'none', color:'#fff', cursor:'pointer'
  });
  closeBtn.addEventListener('click', () => {
    video.pause();
    overlay.remove();
  });
  overlay.appendChild(video);
  overlay.appendChild(closeBtn);
  document.body.appendChild(overlay);
}

function drawSweetSpotPct(rows) {
  const teamF = document.getElementById('ss-team-filter').value;
  const playerF = document.getElementById('ss-player-filter').value;

  const map = {};
  rows.forEach(r =>{
    if (r.PitchCall!=='InPlay') return;
    const ev = parseFloat(r.ExitSpeed);
    if (isNaN(ev)) return;
    const team = getFullTeamName(r[columns.playerTeam], r);
    const bat = r[columns.player];
    map[bat] = map[bat] || { ss:0, pa:0, team };
    map[bat].pa++;
    if (ev>=90 && ev<98) map[bat].ss++;
  });

  let rowsOut = Object.entries(map).map(([bat,s])=>({
    Player: bat,
    'SweetSpot %': +(s.ss/s.pa*100).toFixed(1),
    'Plate Apps': s.pa,
    Team: s.team
  }));
  if (teamF) rowsOut = rowsOut.filter(r=>r.Team===teamF);
  if (playerF) rowsOut = rowsOut.filter(r=>r.Player===playerF);
  rowsOut = rowsOut.filter(r=>r['Plate Apps']>=10)
                   .sort((a,b)=>b['SweetSpot %']-a['SweetSpot %'])
                   .slice(0,10);

  renderLeaderboard('sweetspot-pct', rowsOut, ['Player','SweetSpot %','Plate Apps']);
}




    Papa.parse('./data.csv', {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: results => {
        data = results.data;
            fullData = results.data;

        data.forEach(r => {
          teams.add(getFullTeamName(r[columns.playerTeam],r));
          teams.add(getFullTeamName(r[columns.pitcherTeam],r));
          playersSet.add(r[columns.player]);
        });

        initSearchHandler();
                    populateSuggestions();
        initFilters();
        [
          'hr-team-filter','hr-player-filter',
          'ev-team-filter','ev-player-filter',
          'chase-team-filter','rel-team-filter',
          'avg-ev-team-filter',
          'chase-min-filter','time-filter','catcher-player-filter','catcher-team-filter'
        ].forEach(id =>
          document.getElementById(id).addEventListener('input', computeAndRender)
        );

        // Populate Exit Velocity “Play Result” dropdown
const playResults = [...new Set(data.map(r => r.PlayResult)
                         .filter(v => v && v !== 'Undefined'))]
                     .sort();
playResults.forEach(pr => {
  document
    .getElementById('ev-playresult-filter')
    .append(new Option(pr, pr));
});

// Populate Exit Velocity “AutoPitchType” dropdown
const autoTypes = [...new Set(data.map(r => r.AutoPitchType)
                      .filter(v => v))]   // drop null/undefined
                  .sort();
autoTypes.forEach(pt => {
  document
    .getElementById('ev-autotype-filter')
    .append(new Option(pt, pt));
});

        computeAndRender();
        ['bre-team-filter','bre-batter-filter'].forEach(id => {
  document.getElementById(id).addEventListener('input', computeAndRender);
});
      }
    });

function drawBatterRunExp(rows) {
  // 1) Aggregate Batter → Pitch Type
  const brMap = {};

  rows.forEach(r => {
    const pt  = r[columns.autoType];
    const bat = r[columns.player];
    if (!pt) return;  // skip blank pitch types

    const B    = +r.Balls,
          S    = +r.Strikes,
          call = r.PitchCall,
          hit  = r.TaggedHitType,
          runs = parseInt(r.RunsScored, 10) || 0,
          pre  = RE_COUNT[`${B}-${S}`] || 0;

    // determine post‐pitch RE
    let post;
    if (call === 'BallCalled') {
      const key = `${Math.min(B+1,3)}-${S}`;
      post = RE_COUNT[key] || 0;
    } else if (call === 'StrikeCalled' || call === 'StrikeSwinging') {
      const key = `${B}-${Math.min(S+1,2)}`;
      post = RE_COUNT[key] || 0;
    } else if (hit === 'HomeRun') {
      post = 0;
    } else if (RE_AFTER_HIT[hit] != null) {
      post = RE_AFTER_HIT[hit];
    } else {
      post = RE_AFTER_HIT.Out;
    }

    const rv = (pre - post) + runs;
    const team = getFullTeamName(r[columns.playerTeam], r);

    // accumulate
    brMap[bat] = brMap[bat] || {};
    brMap[bat][pt] = brMap[bat][pt] || { sum:0, c:0, team };
    brMap[bat][pt].sum += rv;
    brMap[bat][pt].c   += 1;
  });

  // 2) Flatten to array
  let brRows = [];
  Object.entries(brMap).forEach(([bat, pts]) => {
    Object.entries(pts).forEach(([pt, v]) => {
      brRows.push({
        Batter:        bat,
        'Pitch Type':  pt,
        'Avg Run Value': (v.sum / v.c).toFixed(3),
        Count:         v.c,
        Team:          v.team
      });
    });
  });

  // 3) Filter out blanks and small samples
  brRows = brRows.filter(r => r['Pitch Type'] && r.Count >= 15);

  // 4) Apply UI filters
  const teamF = document.getElementById('bre-team-filter').value;
  const batF  = document.getElementById('bre-batter-filter').value;
  if (teamF) brRows = brRows.filter(r => r.Team === teamF);
  if (batF)  brRows = brRows.filter(r => r.Batter === batF);

  // 5) Sort descending (highest AvgRunValue first)
  brRows.sort((a, b) => parseFloat(b['Avg Run Value']) - parseFloat(a['Avg Run Value']));

  // 6) Render top 20
  renderLeaderboard('batter-run-exp',
    brRows.slice(0,20),
    ['Batter','Pitch Type','Avg Run Value','Count']
  );

  // 7) Make columns sortable
  const tbl = document.getElementById('batter-run-exp');
  tbl.querySelectorAll('th[data-key]').forEach(th => {
    th.style.cursor = 'pointer';
    th.onclick = () => {
      const key = th.dataset.key.replace(/\s+/g, '');
      const asc = !th.classList.contains('asc');
      brRows.sort((a,b) => {
        const va = isNaN(a[key]) ? a[key] : parseFloat(a[key]);
        const vb = isNaN(b[key]) ? b[key] : parseFloat(b[key]);
        return asc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
      renderLeaderboard('batter-run-exp',
        brRows.slice(0,20),
        ['Batter','Pitch Type','Avg Run Value','Count']
      );
      tbl.querySelectorAll('th').forEach(h=>h.classList.remove('asc','desc'));
      th.classList.add(asc?'asc':'desc');
    };
  });
}

    
function populateSuggestions() {
  const dl = document.getElementById('suggestions');
  dl.innerHTML = '';  // clear old

  // collect all names
  const names = new Set([
    ...data.map(r => r.Batter),
    ...data.map(r => r.Umpire),
    ...data.map(r => r.Pitcher),
    ...data.map(r => r.HomeNameFull),
    ...data.map(r => r.AwayNameFull)
  ]);

  // append in sorted order
  Array.from(names)
    .sort()
    .forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      dl.appendChild(opt);
    });
}

function watchImage(gameUID, pitchUID) {
  // build overlay container
  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position: 'fixed',
    top: 0, left: 0, right: 0, bottom: 0,
    background: 'rgba(0,0,0,0.8)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 10000
  });

  // build image element
  const img = document.createElement('img');
  Object.assign(img.style, {
    maxWidth: '90%',
    maxHeight: '90%',
    boxShadow: '0 0 8px rgba(0,0,0,0.5)'
  });

  // point at your Flask image-stream endpoint
  img.src = `https://helloworld.idkconflict1.workers.dev/stream_image`
    + `?session_id=${encodeURIComponent(gameUID)}`
  + `&play_id=${encodeURIComponent(pitchUID)}`;

  // close button
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '✕';
  Object.assign(closeBtn.style, {
    position: 'absolute',
    top: '10px',
    right: '10px',
    fontSize: '1.5rem',
    background: 'transparent',
    border: 'none',
    color: '#fff',
    cursor: 'pointer'
  });
  closeBtn.addEventListener('click', () => overlay.remove());

  // assemble and show
  overlay.appendChild(img);
  overlay.appendChild(closeBtn);
  document.body.appendChild(overlay);
}


    

function drawTruePitchRunExp(rows) {
  // 1) Aggregate pitcher→pitchType
  const pr = {};
  rows.forEach(r => {
    const pt = r[columns.autoType];
    if (!pt) return;  // skip blank pitch types

    const pit = r[columns.pitcher],
          B   = +r.Balls,
          S   = +r.Strikes,
          call= r[columns.pitchCall],
          hit = r.TaggedHitType,
          runs = parseInt(r.RunsScored, 10) || 0,
          pre  = RE_COUNT[`${B}-${S}`] || 0;

    // determine post‐pitch RE
    let post;
    if (call === 'BallCalled') {
      const key = `${Math.min(B+1,3)}-${S}`;
      post = RE_COUNT[key] || 0;
    } else if (call === 'StrikeCalled' || call === 'StrikeSwinging') {
      const key = `${B}-${Math.min(S+1,2)}`;
      post = RE_COUNT[key] || 0;
    } else if (hit === 'HomeRun') {
      post = 0;
    } else if (RE_AFTER_HIT[hit] != null) {
      post = RE_AFTER_HIT[hit];
    } else {
      // any other in‐play outcome (groundout, flyout, etc.)
      post = RE_AFTER_HIT.Out;
    }

    // run value = RE_before – RE_after + any runs scored
    const rv = (pre - post) + runs;
    const team = getFullTeamName(r[columns.pitcherTeam], r);

    // accumulate
    pr[pit] = pr[pit] || {};
    pr[pit][pt] = pr[pit][pt] || { sum: 0, c: 0, team };
    pr[pit][pt].sum += rv;
    pr[pit][pt].c   += 1;
  });

  // 2) Flatten to array
  let output = [];
  Object.entries(pr).forEach(([pit, pts]) => {
    Object.entries(pts).forEach(([pt, v]) => {
      output.push({
        Pitcher:      pit,
        'Pitch Type': pt,
        AvgRunValue:  (v.sum / v.c).toFixed(3),
        Count:        v.c,
        Team:         v.team
      });
    });
  });

  // 3) Filter out small samples & blanks
  output = output.filter(r => r['Pitch Type'] && r.Count >= 15);

  // 4) Apply UI filters
  const teamF = document.getElementById('pre-team-filter').value;
  const pitF  = document.getElementById('pre-pitcher-filter').value;
  if (teamF) output = output.filter(r => r.Team === teamF);
  if (pitF)  output = output.filter(r => r.Pitcher === pitF);

  // 5) Sort by effectiveness (lowest AvgRunValue first)
  output.sort((a, b) => parseFloat(a.AvgRunValue) - parseFloat(b.AvgRunValue));

  // 6) Render top 20
  renderLeaderboard('pitch-run-exp',
    output.slice(0,20),
    ['Pitcher','Pitch Type','AvgRunValue','Count']
  );

  // 7) Make columns sortable
  const tbl = document.getElementById('pitch-run-exp');
  tbl.querySelectorAll('th[data-key]').forEach(th => {
    th.style.cursor = 'pointer';
    th.onclick = () => {
      const key = th.dataset.key.replace(/\s+/g, '');
      const asc = !th.classList.contains('asc');
      output.sort((a,b) => {
        const va = isNaN(a[key]) ? a[key] : parseFloat(a[key]);
        const vb = isNaN(b[key]) ? b[key] : parseFloat(b[key]);
        return asc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
      renderLeaderboard('pitch-run-exp',
        output.slice(0,20),
        ['Pitcher','Pitch Type','AvgRunValue','Count']
      );
      tbl.querySelectorAll('th').forEach(h=>h.classList.remove('asc','desc'));
      th.classList.add(asc?'asc':'desc');
    };
  });
}
  // filters
  const teamF = document.getElementById('pre-team-filter').value;
  const pitF  = document.getElementById('pre-pitcher-filter').value;
  if (teamF) prRows = prRows.filter(r => r.Team === teamF);
  if (pitF)  prRows = prRows.filter(r => r.Pitcher === pitF);

  // sort ascending for “most effective” (lowest RV first)
  prRows.sort((a,b) => parseFloat(a.AvgRunValue) - parseFloat(b.AvgRunValue));

  // render top 20
  renderLeaderboard('pitch-run-exp',
    prRows.slice(0,20),
    ['Pitcher','Pitch Type','AvgRunValue','Count']
  );

  // make columns sortable by clicking headers
  const tbl = document.getElementById('pitch-run-exp');
  tbl.querySelectorAll('th[data-key]').forEach(th => {
    th.style.cursor = 'pointer';
    th.onclick = () => {
      const key = th.dataset.key.replace(/\s+/g,'');
      const asc = !th.classList.contains('asc');
      prRows.sort((a,b) => {
        const va = key==='Pitcher'||key==='PitchType'
                   ? a[key] : parseFloat(a[key]);
        const vb = key==='Pitcher'||key==='PitchType'
                   ? b[key] : parseFloat(b[key]);
        return asc ? (va>vb?1:-1) : (va<vb?1:-1);
      });
      renderLeaderboard('pitch-run-exp', prRows.slice(0,20),
                        ['Pitcher','Pitch Type','AvgRunValue','Count']);
      tbl.querySelectorAll('th').forEach(h=>h.classList.remove('asc','desc'));
      th.classList.add(asc?'asc':'desc');
    };
  });

     document.getElementById('modalClose').addEventListener('click', () => {
          document.getElementById('modalOverlay').classList.remove('show');
          document.getElementById('animFrame').src = '';
        });
        document.getElementById('modalOverlay').addEventListener('click', e => {
          if (e.target.id === 'modalOverlay') {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('animFrame').src = '';
          }
        });

        function attachViewButtons() {
          document.querySelectorAll('.viewBtn').forEach(btn => {
            btn.addEventListener('click', () => {
              const uid = btn.dataset.pitchuid;
              document.getElementById('animFrame').src = `animate.html?pitchUID=${encodeURIComponent(uid)}`;
              document.getElementById('modalOverlay').classList.add('show');
            });
          });
        }

    // Attach form submit after data is ready
    function initSearchHandler() {
      document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const q = document.getElementById('search').value.trim();

        const isUmp = data.some(r => r.Umpire === q);
        if (isUmp) {
          window.location.href = `ump-profiles.html?player=${encodeURIComponent(q)}`;
          return;
        }

        const isPitcher = data.some(r => r.Pitcher === q);
        if (isPitcher) {
          window.location.href = `pitcher-profiles.html?player=${encodeURIComponent(q)}`;
          return;
        }

        // Check if query matches a batter
        const isBatter = data.some(r => r.Batter === q);
        if (isBatter) {
          window.location.href = `batter-profiles.html?player=${encodeURIComponent(q)}`;
          return;
        }

        // Otherwise check if it matches a team
        const isTeam = data.some(r => r.HomeNameFull === q || r.AwayNameFull === q);
        if (isTeam) {
          window.location.href = `team-profiles.html?team=${encodeURIComponent(q)}`;
          return;
        }

        // Fallback: no match
        alert('No matching player or team found.');
      });
    }

document.querySelectorAll('.back-to-top').forEach(btn => {
  btn.addEventListener('click', () => {
    document.getElementById('top').scrollIntoView({ behavior: 'smooth' });
  });
});



  </script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyBgBqrrRBB1vvAnQ9mNBt9Vq6p2NWeKYZw",
      authDomain: "revs-2c987.firebaseapp.com",
      projectId: "revs-2c987",
      storageBucket: "revs-2c987.firebasestorage.app",
      messagingSenderId: "181256684157",
      appId: "1:181256684157:web:a9e1c5dfd767658e2ba714",
      measurementId: "G-2050889X0C"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    firebase.initializeApp(firebaseConfig);
  
  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const auth = firebase.auth();
  
        // Redirect to login if not authenticated
        auth.onAuthStateChanged(user => {
          if (!user) {
            window.location.href = 'login.html';
          } else {
          }
        });
  
       
      });
  </script>
</body>
</html>
