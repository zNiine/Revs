<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Batter Scouting Reports</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    select { font-size: 1rem; margin-bottom: 1rem; }

.spray-box,
.third-box {
  flex: 1;
  height: 320px;
}

.approach-box {
  flex: 1;
  min-height: 320px;      /* ensures at least 320px tall */
  position: relative;     /* keep absolute children scoped here */
  overflow: visible;      /* allow the grid to expand it */
}





    /* REPORT PAGE */
    .report-page {
      page-break-after: always;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 2rem;
    }
    .report-header { font-size: 1.5rem; margin-bottom: .5rem; }

    /* SMALLER TABLES */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.2rem 0.4rem;
      text-align: center;
    }

    /* CHART ROW: approach (2) vs spray (1) */
    .flex-row { display: flex; gap: 1rem; }
    .chart-box {
      border: 1px solid #eee;
      position: relative;
      background: #fafafa;
    }
    .approach-box { flex: 2; height: 320px; }
    .spray-box    { flex: 1; height: 320px; }

    /* SINGLE LEGEND */
    .legend {
      position: absolute;
      bottom: 4px; left: 4px;
      background: rgba(255,255,255,0.8);
      font-size: 0.9rem;
      padding: 4px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <label>
    Select Team:
    <select id="teamSelect">
      <option value="">-- pick a team --</option>
    </select>
  </label>

  <div id="reports"></div>

  <script>
  // 1) Load CSV
  Papa.parse('data.csv', {
    header: true, download: true,
    complete: results => {
      window._data = results.data;
      initTeamPicker();
    }
  });

  // 2) Populate team dropdown
  function initTeamPicker() {
    const teams = Array.from(new Set(_data.map(r => r.BatterTeam))).sort();
    const sel = document.getElementById('teamSelect');
    teams.forEach(t => {
      const o = document.createElement('option');
      o.value = t; o.textContent = t;
      sel.appendChild(o);
    });
    sel.addEventListener('change', () => buildReports(sel.value));
  }

  // 3) Build reports (2 pages per batter)
  function buildReports(team) {
    const container = document.getElementById('reports');
    container.innerHTML = '';
    if (!team) return;

    const teamRows = _data.filter(r => r.BatterTeam === team);
    const batters = Array.from(new Set(teamRows.map(r => r.Batter))).sort();

    batters.forEach(batter => {
      ['Left','Right'].forEach(side => {
        const vs = teamRows.filter(r =>
          r.Batter===batter && r.PitcherThrows===side
        );
        if (!vs.length) return;
        const page = renderBatterPage(batter, side, vs);
        container.appendChild(page);

        const base = (batter+'-'+side)
          .replace(/\s+/g,'_')
          .replace(/[^A-Za-z0-9_-]/g,'');
        renderApproachByCount(vs, `approach_${base}`);
      });
    });
  }

  // 4) Render one page
  function renderBatterPage(name, side, rows) {
    const base = (name+'-'+side)
      .replace(/\s+/g,'_')
      .replace(/[^A-Za-z0-9_-]/g,'');
    const appId   = `approach_${base}`;
    const sprayId = `spray_${base}`;

    const page = document.createElement('div');
    page.className = 'report-page';
    page.innerHTML = `
      <div class="report-header">
        ${name} vs. ${side==='Left'?'LHP':'RHP'}
      </div>
    `;

    // Tables
    page.appendChild(renderPitchTypeTable(computePitchTypeMetrics(rows)));
    page.appendChild(renderCountSummaryTable(computeCountSummary(rows)));

    // Charts
    const charts = document.createElement('div'); charts.className='flex-row';
    const a = document.createElement('div');
      a.id = appId; a.className='chart-box approach-box';
    const s = document.createElement('div');
      s.id = sprayId; s.className='chart-box spray-box';
      s.innerHTML = '<em>spray chart here</em>';
    const t = document.createElement('div');
  t.id = `other_${base}`;       // give it a unique ID
  t.className = 'chart-box third-box';
  t.innerHTML = '<em>third chart here</em>';

charts.append(a, s, t);
    page.appendChild(charts);

    return page;
  }

  // 5) Pitch‐Type metrics (AVG, SLG, chase)
  function computePitchTypeMetrics(rows) {
    const total = rows.length, byType = {};
    rows.forEach(r=>{
      const t = r.AutoPitchType || 'undefined';
      if (!byType[t]) byType[t] = {
        cnt:0, ab:0, hits:0, TB:0,
        ev:0, la:0,
        sw:0, wh:0,
        ooz:0, chase:0
      };
      const m = byType[t];
      m.cnt++;

      // swing/take
      const swung = !['BallCalled','StrikeCalled'].includes(r.PitchCall);

      // in‐zone?
      const side   = +r.PlateLocSide, ht = +r.PlateLocHeight;
      const inZ = !isNaN(side)&&!isNaN(ht)&&
                  side>=-0.85&&side<=0.85&&
                  ht>=1.5&&ht<=3.5;
      if (!inZ) {
        m.ooz++;
        if (swung) m.chase++;
      }

      // AB & TB
      if (r.KorBB!=='Walk') {
        m.ab++;
        if (/Single|Double|Triple|HomeRun/.test(r.PlayResult)) {
          m.hits++;
          let b=0;
          if (r.PlayResult==='Single')   b=1;
          if (r.PlayResult==='Double')   b=2;
          if (r.PlayResult==='Triple')   b=3;
          if (r.PlayResult==='HomeRun')  b=4;
          m.TB += b;
        }
      }

      // EV & LA
      if (!isNaN(+r.ExitSpeed)) m.ev += +r.ExitSpeed;
      if (!isNaN(+r.Angle))     m.la += +r.Angle;

      // whiff
      if (swung) {
        m.sw++;
        if (r.PitchCall==='StrikeSwinging') m.wh++;
      }
    });

    return Object.entries(byType).map(([type,m])=>({
      AutoPitchType: type,
      pct:  (m.cnt/total*100).toFixed(1)+'%',
      AVG:  m.ab ? (m.hits/m.ab).toFixed(3).slice(1) : '-',
      SLG:  m.ab ? (m.TB  /m.ab).toFixed(3).slice(1) : '-',
      ExitVelo: m.cnt? (m.ev/m.cnt).toFixed(1):'-',
      LA:       m.cnt? (m.la/m.cnt).toFixed(1):'-',
      Swing:    m.cnt? (m.sw/m.cnt*100).toFixed(1)+'%':'-',
      Chase:    m.ooz ? (m.chase/m.ooz*100).toFixed(1)+'%':'-',
      Whiff:    m.sw  ? (m.wh/m.sw*100).toFixed(1)+'%':'-'
    }));
  }

  // 6) Count summary
  function computeCountSummary(rows) {
    const byC = {};
    rows.forEach(r=>{
      const k=`${r.Balls}-${r.Strikes}`;
      if (!byC[k]) byC[k] = {seen:0,zone:0,sw:0,ch:0,wh:0};
      const m=byC[k];
      m.seen++;
      if (r.PitchCall==='StrikeCalled') m.zone++;
      if (!['BallCalled','StrikeCalled'].includes(r.PitchCall)) {
        m.sw++;
        if (r.PitchCall==='BallCalled')       m.ch++;
        if (r.PitchCall==='StrikeSwinging')   m.wh++;
      }
    });
    return Object.entries(byC).map(([cnt,m])=>({
      Count: cnt,
      PitchesSeen: m.seen,
      InZone: m.zone,
      Swing: m.sw,
      Chase: m.ch,
      Whiff: m.wh
    }));
  }

  // 7) Table renderers
  function renderPitchTypeTable(data) {
    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead>
<tr>
  <th>AutoPitchType</th><th>%</th><th>AVG</th><th>SLG</th>
  <th>Exit Velo</th><th>LA</th><th>Swing</th><th>Chase</th><th>Whiff</th>
</tr></thead>`;
    tbl.innerHTML += `<tbody>${data.map(r=>`
<tr>
  <td>${r.AutoPitchType}</td><td>${r.pct}</td><td>${r.AVG}</td>
  <td>${r.SLG}</td><td>${r.ExitVelo}</td><td>${r.LA}</td>
  <td>${r.Swing}</td><td>${r.Chase}</td><td>${r.Whiff}</td>
</tr>`).join('')}</tbody>`;
    return tbl;
  }
  function renderCountSummaryTable(data) {
    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead>
<tr><th>Count</th><th>Pitches Seen</th><th>In Zone</th>
    <th>Swing</th><th>Chase</th><th>Whiff</th>
</tr></thead>`;
    tbl.innerHTML += `<tbody>${data.map(r=>`
<tr>
  <td>${r.Count}</td><td>${r.PitchesSeen}</td><td>${r.InZone}</td>
  <td>${r.Swing}</td><td>${r.Chase}</td><td>${r.Whiff}</td>
</tr>`).join('')}</tbody>`;
    return tbl;
  }

  // 8) Approach-by-Count pie-grid
  function renderApproachByCount(rows, cId) {
    const tree = {};
    rows.forEach(r=>{
      const k=`${r.Balls}-${r.Strikes}`;
      const act = ['BallCalled','StrikeCalled'].includes(r.PitchCall)?'Take':'Swing';
      tree[k] = tree[k]||{Take:0,Swing:0};
      tree[k][act]++;
    });

    const cont = document.getElementById(cId);
    if (!cont) return;
    cont.innerHTML = ''; cont.style.position = 'relative';

    const pairs = Object.keys(tree).map(k=>k.split('-').map(Number));
    const maxTier = pairs.reduce((m,[b,s])=>Math.max(m,b+s),0);
    const BOX=50, XSP=50, YSP=50;

    for (let sum=0; sum<=maxTier; sum++) {
      const tier = [];
      for (let b=0;b<=3;b++){
        const s=sum-b; if(s<0||s>2) continue;
        tier.push({b,s,counts:tree[`${b}-${s}`]||{Take:0,Swing:0}});
      }
      tier.sort((a,b)=>b.b-a.b);
      const rowW = (tier.length-1)*XSP+BOX;
      const startX = (cont.clientWidth-rowW)/2;

      tier.forEach((cell,i)=>{
        const d=document.createElement('div');
        d.style.cssText=`
          position:absolute;
          left:${startX+i*XSP}px;
          top:${sum*YSP}px;
          color: white;
          width:${BOX}px;height:${BOX}px;
        `;
        cont.appendChild(d);
        const labels=['Take','Swing'];
                const values=labels.map(l=>cell.counts[l]||0);

const nonZeroCount = values.filter(v => v>0).length;
const textInfo = nonZeroCount > 1 ? 'percent' : 'none';
        Plotly.newPlot(d,[{
          type:'pie',
          hole:0.0,
                    labels,values,

          textinfo:textInfo,
          marker:{ colors:['green','blue'] }
        }],{
                    showlegend: false,

          margin:{t:0,b:0,l:0,r:0},
          paper_bgcolor:'rgba(0,0,0,0)',
          plot_bgcolor:'rgba(0,0,0,0)'
        },{displayModeBar:false});

        const tot=values.reduce((a,b)=>a+b,0);
        const lbl=document.createElement('div');
        lbl.innerHTML=`${cell.b}-${cell.s}<br>${tot}`;
        lbl.style.cssText=`
          position:absolute;
          left:50%;top:50%;
          transform:translate(-50%,-50%);
          font-size:10px;pointer-events:none;
        `;
        d.appendChild(lbl);
      });
    }

    // single legend
    const lg=document.createElement('div');
    lg.className='legend';
    lg.innerHTML=`
      <div><span style="display:inline-block;
           width:12px;height:12px;background:green;"></span> Take
      </div>
      <div><span style="display:inline-block;
           width:12px;height:12px;background:blue;"></span> Swing
      </div>`;
    cont.appendChild(lg);
  }
  </script>
</body>
</html>
