<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>All League Transactions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:1rem; background:#f4f4f4 }
    h1 { text-align: center; margin-bottom:1rem }
    #controls { text-align:center; margin-bottom:1rem }
    button { padding:.5rem 1rem; font-size:1rem; cursor:pointer }
    #loading { text-align:center; margin:2rem 0; font-style:italic }
    #error { color:red; text-align:center; margin:1rem 0 }
    table { width:100%; border-collapse:collapse; margin-top:1rem; background:white }
    th, td { border:1px solid #ddd; padding:.5rem; text-align:left }
    th { background:#333; color:#fff; position:sticky; top:0 }
    tr:nth-child(even) { background:#f9f9f9 }
  </style>
</head>
<body>
  <h1>Recent Transactions (MiLB, LMB, AA)</h1>
  <div id="controls">
    <button id="scrape-btn">Refresh Data</button>
    <div id="google_translate_element"></div>

  </div>
  <div id="loading">Loading transactions…</div>
  <div id="error" hidden></div>
  <table id="tx-table" hidden>
    <thead>
      <tr>
        <th>Date</th>
        <th>Source</th>
        <th>Team</th>
        <th>Transaction</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_BASE        = 'https://helloworld.idkconflict1.workers.dev';
    const SCRAPE_ENDPOINT = `${API_BASE}/scrape`;

    document.getElementById('scrape-btn')
      .addEventListener('click', fetchAndRender);

    // initial load
    fetchAndRender();

    async function fetchAndRender() {
      const loadingEl = document.getElementById('loading');
      const errorEl   = document.getElementById('error');
      const tableEl   = document.getElementById('tx-table');
      const btn       = document.getElementById('scrape-btn');

      // reset UI
      errorEl.hidden = true;
      tableEl.hidden = true;
      loadingEl.textContent = 'Refreshing transactions…';
      loadingEl.hidden = false;
      btn.disabled = true;

      try {
        const res = await fetch(SCRAPE_ENDPOINT);
        if (!res.ok) throw new Error(`Worker returned HTTP ${res.status}`);
        const data = await res.json();

        // flatten:
        // - for MiLB: only keep “released…” entries, strip prefix
        // - for LMB & AA: include everything as-is
        const rows = [];
        for (const date of Object.keys(data)) {
          for (const src of ['milb','lmb','aa']) {
            const arr = data[date][src] || [];
            if (src === 'milb') {
              for (const tx of arr) {
                const desc = (tx.transaction||tx.description||'').trim();
                const idx  = desc.toLowerCase().indexOf('released');
                if (idx === -1) continue;
                const trans = desc.substring(idx);
                rows.push({
                  date,
                  source: 'MiLB',
                  team:   tx.team,
                  transaction: trans
                });
              }
            } else {
              for (const tx of arr) {
                rows.push({
                  date,
                  source: src.toUpperCase(),
                  team:   tx.team,
                  transaction: tx.transaction
                });
              }
            }
          }
        }

        // dedupe on date|source|team|transaction
        const seen = new Set();
        const unique = rows.filter(r => {
          const key = [r.date, r.source, r.team, r.transaction].join('|');
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        // sort newest-first
        unique.sort((a,b) => b.date.localeCompare(a.date));

        if (unique.length === 0) {
          loadingEl.textContent = 'No transactions found.';
        } else {
          renderTable(unique);
          loadingEl.hidden = true;
          tableEl.hidden   = false;
        }
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Error: ' + err.message;
        errorEl.hidden = false;
        loadingEl.hidden = true;
      } finally {
        btn.disabled = false;
      }
    }

    function renderTable(data) {
      const tbody = document.querySelector('#tx-table tbody');
      tbody.innerHTML = '';
      for (const { date, source, team, transaction } of data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${source}</td>
          <td>${team}</td>
          <td>${transaction}</td>
        `;
        tbody.appendChild(tr);
      }
    }
  </script>

  <script type="text/javascript">
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({
      pageLanguage: 'es',            // source page is Spanish
      includedLanguages: 'en',       // offer only English
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE
    }, 'google_translate_element');
  }
</script>
<script 
  type="text/javascript" 
  src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit">
</script>

</body>
</html>
